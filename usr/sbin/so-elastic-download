#!/bin/bash

. /usr/sbin/so-elastic-common

header "Adding Docker repo"
cp $SRC/etc/apt/preferences.d/securityonion-docker /etc/apt/preferences.d/
apt-get -y install apt-transport-https ca-certificates curl > /dev/null
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -
add-apt-repository        "deb [arch=amd64] https://download.docker.com/linux/ubuntu \
       $(lsb_release -cs) \
       stable"
echo "Done!"

header "Updating package list"
apt-get update > /dev/null
echo "Done!"

header "Installing Docker"
apt-get -y install docker-ce > /dev/null
echo "Done!"

header "Enabling DOCKER_CONTENT_TRUST"
echo "export DOCKER_CONTENT_TRUST=1" >> /etc/profile.d/securityonion-docker.sh
export DOCKER_CONTENT_TRUST=1
echo "Done!"

header "Downloading Docker containers"
for i in so-elasticsearch so-kibana so-logstash so-elastalert so-curator so-freqserver so-domainstats; do
	docker pull --disable-content-trust=false $DOCKERHUB/$i
done
echo "Done!"

header "Installing new packages"
apt-get install -y securityonion-samples-bro libapache2-mod-authnz-external > /dev/null
echo "Done!"

header "Updating existing packages"
apt-get install -y securityonion-setup securityonion-sostat > /dev/null
echo "Done!"
